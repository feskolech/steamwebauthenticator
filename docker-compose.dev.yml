services:
  backend:
    build:
      context: ./backend
      target: development
    command: npm run dev
    environment:
      NODE_ENV: development
      PORT: 3001
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules

  frontend:
    build:
      context: ./frontend
      target: development
    command: npm run dev -- --host 0.0.0.0 --port 3000
    environment:
      VITE_PROXY_TARGET: http://backend:3001
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules

  telegram-bot:
    command: python -m bot
    volumes:
      - ./bot:/app

  cypress:
    image: cypress/included:13.17.0
    working_dir: /app
    depends_on:
      - frontend
    environment:
      CYPRESS_baseUrl: http://frontend:3000
    volumes:
      - ./frontend:/app
    entrypoint:
      - /bin/sh
      - -c
      - |
        for i in $(seq 1 60); do
          wget -qO- http://frontend:3000 >/dev/null 2>&1 && break
          sleep 2
        done
        cypress run --browser electron
    networks:
      - app_public

volumes:
  backend_node_modules:
  frontend_node_modules:
